### TRIỂN KHAI ELK STACK TRÊN DOCKER SWARM ###

## KHỞI TẠO DOCKER SWARM (Nếu chưa có)
# Trên máy ảo VirtualBox
docker swarm init --advertise-addr <IP_máy_ảo>

## TRIỂN KHAI ELK STACK
# Triển khai toàn bộ stack (Elasticsearch, Kibana, Logstash và Filebeat) qua Docker Swarm
docker stack deploy -c docker-stack.yml elk_stack

# Kiểm tra trạng thái các service
docker service ls
docker service ps elk_stack_elasticsearch
docker service ps elk_stack_kibana
docker service ps elk_stack_logstash
docker service ps elk_stack_filebeat

## KIỂM TRA HỆ THỐNG

# 1. Kiểm tra Elasticsearch
curl -X GET "http://localhost:9200/_cluster/health?pretty"
curl -X GET "http://localhost:9200/_cat/indices?v"

# 2. Kiểm tra logs trong Elasticsearch (sau khi có dữ liệu)
curl -X GET "http://localhost:9200/logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "size": 5,
  "sort": [{"@timestamp": {"order": "desc"}}]
}'

# 3. Kiểm tra xem Kibana đã kết nối được với Elasticsearch
# Truy cập: http://<IP_máy_ảo>:5601

## THỰC HIỆN CÁC TRUY VẤN QUAN TRỌNG

# 1. Tìm logs từ service rng
curl -X GET "http://localhost:9200/logs-rng-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {"match_all": {}},
  "size": 10,
  "sort": [{"@timestamp": {"order": "desc"}}]
}'

# 2. Tìm logs cấp độ ERROR
curl -X GET "http://localhost:9200/logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {"match": {"tags": "error_log"}},
  "size": 10,
  "sort": [{"@timestamp": {"order": "desc"}}]
}'

# 3. Thống kê số lượng log theo service
curl -X GET "http://localhost:9200/logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "size": 0,
  "aggs": {
    "service_count": {
      "terms": {"field": "service_name.keyword", "size": 10}
    }
  }
}'

## QUẢN LÝ STACK

# Cập nhật stack sau khi chỉnh sửa file
docker stack deploy -c docker-stack.yml elk_stack

# Xóa stack
docker stack rm elk_stack

# Kiểm tra logs của các service
docker service logs elk_stack_elasticsearch
docker service logs elk_stack_logstash
docker service logs elk_stack_kibana
docker service logs elk_stack_filebeat 